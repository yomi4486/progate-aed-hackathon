# 要件定義書

## はじめに

本プロジェクトは、指定された Web サイト群をクロールし、BM25 とベクトル検索を組み合わせたハイブリッド検索システムを構築することを目的としています。Amazon OpenSearch と Bedrock 埋め込みを活用し、日本語・英語混在環境での高精度な検索体験を提供します。

## 要件

### 要件 1：Web クローリングシステム

**ユーザーストーリー:** システム管理者として、指定した Web サイト群を自動的にクロールし、コンテンツを収集・保存できるようにしたい。これにより、検索対象データを継続的に更新できる。

#### 受け入れ基準

1. WHEN 管理者がクロール対象 URL を指定 THEN システムは robots.txt と sitemap を尊重してクロールを実行する
2. WHEN クロールが実行される THEN システムは HTML からテキストを抽出し、言語判定を行う
3. WHEN コンテンツが取得される THEN システムは S3 に raw/parsed/index-ready 形式で保存する
4. WHEN クロール中にエラーが発生 THEN システムは指数バックオフでリトライを実行する
5. WHEN 同一ドメインへのアクセス THEN システムはドメイン毎の QPS 制御を適用する

### 要件 2：ハイブリッド検索エンジン

**ユーザーストーリー:** エンドユーザーとして、BM25 とベクトル検索を組み合わせた高精度な検索を実行し、関連性の高い結果を取得したい。これにより、従来のキーワード検索では見つからない関連コンテンツも発見できる。

#### 受け入れ基準

1. WHEN ユーザーが検索クエリを入力 THEN システムは BM25 とベクトル検索の両方を実行する
2. WHEN ハイブリッド検索が実行される THEN システムは RRF (Reciprocal Rank Fusion) でスコアを統合する
3. WHEN 検索結果が生成される THEN システムは Top-10 の結果を 500ms 以内で返却する
4. WHEN 日本語クエリが入力される THEN システムは MeCab で適切に形態素解析する
5. WHEN 検索結果が表示される THEN システムはハイライトとスニペットを含める

### 要件 3：ベクトル埋め込み処理

**ユーザーストーリー:** システムとして、Amazon Bedrock を使用してドキュメントのベクトル埋め込みを生成し、セマンティック検索を可能にしたい。これにより、キーワードが一致しなくても意味的に関連するコンテンツを検索できる。

#### 受け入れ基準

1. WHEN 新しいドキュメントが追加される THEN システムは Bedrock (Titan または Cohere) で埋め込みを生成する
2. WHEN 埋め込み生成が完了 THEN システムは OpenSearch の knn_vector フィールドに保存する
3. WHEN バッチ処理が実行される THEN システムは夜間に大量ドキュメントの埋め込みを効率的に処理する
4. WHEN 埋め込み処理でエラーが発生 THEN システムは失敗したドキュメントを再処理キューに追加する
5. WHEN コスト最適化が必要 THEN システムは FP16/INT8 圧縮を適用する

### 要件 4：検索 API

**ユーザーストーリー:** 開発者として、Python (FastAPI) で構築された RESTful API を通じて検索機能にアクセスし、フロントエンドアプリケーションに統合したい。これにより、様々なクライアントから検索機能を利用できる。

#### 受け入れ基準

1. WHEN API エンドポイントに GET リクエストが送信される THEN システムは検索結果を JSON 形式で返却する
2. WHEN 検索パラメータが指定される THEN システムはページング、フィルタ、ソートを適用する
3. WHEN 大量のリクエストが発生 THEN システムは Auto Scaling で負荷に対応する
4. WHEN API エラーが発生 THEN システムは適切な HTTP ステータスコードとエラーメッセージを返却する
5. WHEN レスポンス時間が測定される THEN システムは P95 レイテンシを 500ms 以下に維持する

### 要件 5：Web ユーザーインターフェース

**ユーザーストーリー:** エンドユーザーとして、React で構築された直感的な Web インターフェースを通じて検索を実行し、結果を閲覧したい。これにより、技術的な知識がなくても検索システムを利用できる。

#### 受け入れ基準

1. WHEN ユーザーが検索ページにアクセス THEN システムは検索フォームとサジェスト機能を表示する
2. WHEN 検索が実行される THEN システムは結果一覧をハイライト付きで表示する
3. WHEN 検索結果が表示される THEN システムはタイトル、スニペット、URL を含める
4. WHEN 日本語・英語混在クエリが入力される THEN システムは適切に処理して結果を表示する
5. WHEN モバイルデバイスからアクセス THEN システムはレスポンシブデザインで表示する

### 要件 6：インフラストラクチャとデプロイメント

**ユーザーストーリー:** DevOps エンジニアとして、Terraform を使用して AWS インフラを自動化し、一貫性のあるデプロイメントを実現したい。これにより、環境間の差異を排除し、運用効率を向上させる。

#### 受け入れ基準

1. WHEN Terraform が実行される THEN システムは VPC、OpenSearch、S3、ECS 等のリソースを作成する
2. WHEN 環境が分離される THEN システムは dev/stg/prod 用のワークスペースを提供する
3. WHEN セキュリティが適用される THEN システムは KMS 暗号化、IAM 最小権限、WAF を設定する
4. WHEN 監視が設定される THEN システムは New Relic ダッシュボードとアラートを作成する
5. WHEN 状態管理が実行される THEN システムは S3 バックエンドと DynamoDB ロックを使用する

### 要件 7：監視と運用

**ユーザーストーリー:** 運用チームとして、New Relic を使用してシステムの健全性とパフォーマンスを監視し、問題を早期に検出したい。これにより、サービスの可用性と品質を維持できる。

#### 受け入れ基準

1. WHEN システムが稼働 THEN New Relic は QPS、レイテンシ、エラー率を追跡する
2. WHEN 閾値を超過 THEN New Relic アラートが発火し、通知を送信する
3. WHEN ダッシュボードが表示される THEN 運用者は New Relic でクロール進捗と検索品質メトリクスを確認できる
4. WHEN ログが生成される THEN システムは構造化ログを New Relic に送信する
5. WHEN パフォーマンス分析が必要 THEN New Relic で NDCG@10 と Recall@10 メトリクスを可視化する

### 要件 8：品質保証と評価

**ユーザーストーリー:** 品質保証チームとして、検索システムの精度と性能を定量的に評価し、継続的な改善を行いたい。これにより、ユーザー体験の向上を実現できる。

#### 受け入れ基準

1. WHEN 評価が実行される THEN システムはサンプルクエリ 50 件で NDCG@10 ≥ 0.35 を達成する
2. WHEN パフォーマンステストが実行される THEN システムは 5-10 万ドキュメントで安定動作する
3. WHEN A/B テストが実施される THEN システムはクリック率と滞在時間を測定する
4. WHEN 品質改善が必要 THEN システムは再ランキングとシノニム辞書を適用する
5. WHEN 増分更新が実行される THEN システムは ETag/Last-Modified ベースで効率的に更新する
